<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Performance Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #1a1d23;
            --secondary: #2a2f38;
            --accent: #00d4aa;
            --accent-hover: #00b894;
            --danger: #ff4757;
            --warning: #ffa502;
            --text-primary: #ffffff;
            --text-secondary: #a0a6b1;
            --border: #363b47;
            --surface: #252930;
            --surface-hover: #2f3541;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 400;
        }

        .main-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--secondary);
            border-right: 1px solid var(--border);
            padding: 0;
            width: 280px;
            flex-shrink: 0;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 32px 24px 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .logo-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .nav-menu {
            padding: 24px 0;
            list-style: none;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
        }

        .nav-link:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: var(--surface);
            color: var(--accent);
            border-right: 2px solid var(--accent);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .content-area {
            flex: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin-left: 280px;
        }

        .top-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .export-controls {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .main-content {
            padding: 32px;
            flex: 1;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(16px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            border-color: var(--accent);
            background: var(--surface-hover);
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-wrapper {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .chart-container {
            text-align: center;
        }

        .chart-container iframe {
            border-radius: 6px;
            max-width: 100%;
            border: none;
            width: 100%;
            min-height: 400px;
        }

        .calculator-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .calculator-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field {
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        .calculate-btn {
            background: var(--accent);
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calculate-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .result-panel {
            background: var(--primary);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 24px;
            margin-top: 24px;
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }

        .result-item {
            text-align: center;
            padding: 16px;
            background: var(--surface);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .result-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .result-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .portfolio-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .breakdown-item {
            background: var(--secondary);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
        }

        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
            
            .content-area {
                margin-left: 240px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                overflow-y: auto;
                order: 1;
            }
            
            .content-area {
                margin-left: 0;
                order: 2;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container iframe {
                width: 100%;
                height: 300px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .portfolio-section {
                margin-bottom: 32px;
            }
            
            /* Calculator responsive adjustments */
            .calculator-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                max-width: none;
                border-radius: 0;
                transform: translateY(100%);
            }
            
            .calculator-overlay.active {
                transform: translateY(0);
            }
            
            .floating-calculator {
                padding: 16px;
            }
            
            .calculator-drag-handle {
                display: none;
            }
            
            .calculator-resize-handle {
                display: none;
            }
            
            .calculator-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .calc-btn {
                min-height: 48px;
                font-size: 14px;
                padding: 8px 4px;
            }
            
            .calculator-display {
                padding: 20px 16px;
            }
            
            .calc-result {
                font-size: 28px;
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                padding: 12px 20px;
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .export-controls {
                align-self: stretch;
                justify-content: center;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .metric-card {
                padding: 16px;
            }
            
            .metric-value {
                font-size: 24px;
            }
            
            .section-title {
                font-size: 20px;
                margin-bottom: 16px;
            }
            
            .chart-wrapper {
                padding: 16px;
            }
            
            .chart-title {
                font-size: 14px;
            }
            
            .calculator-section {
                padding: 20px;
            }
            
            .calculator-title {
                font-size: 16px;
            }
            
            .form-grid {
                gap: 16px;
            }
            
            .input-field {
                padding: 10px 12px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Calculator mobile optimizations */
            .floating-calculator {
                padding: 12px;
            }
            
            .calculator-header {
                margin-bottom: 12px;
            }
            
            .calculator-title {
                font-size: 16px;
            }
            
            .mode-toggle {
                margin: 0 8px;
            }
            
            .mode-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .calculator-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .calc-btn {
                min-height: 44px;
                font-size: 13px;
                padding: 6px 4px;
            }
            
            .calc-btn.wide {
                grid-column: span 2;
            }
            
            .trig-functions {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 6px !important;
            }
            
            .variables-section {
                margin-top: 8px;
                padding-top: 8px;
            }
            
            .variable-input {
                flex-direction: column;
                gap: 6px;
            }
            
            .variable-input input {
                padding: 8px;
                font-size: 14px;
            }
            
            .variable-input button {
                padding: 8px 16px;
                align-self: flex-start;
            }
            
            .stored-variables {
                gap: 6px;
            }
            
            .variable-chip {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .history-section {
                margin-top: 8px;
                padding-top: 8px;
            }
            
            .history-item {
                padding: 6px;
                font-size: 11px;
            }
            
            /* Floating buttons responsive */
            .floating-buttons {
                bottom: 16px;
                right: 16px;
                gap: 8px;
            }
            
            .floating-btn {
                width: 48px;
                height: 48px;
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 12px;
            }
            
            .portfolio-section {
                margin-bottom: 24px;
                padding-bottom: 24px;
            }
            
            .section-title {
                font-size: 18px;
                margin-bottom: 12px;
                padding-left: 12px;
            }
            
            .chart-wrapper {
                padding: 12px;
            }
            
            .chart-container iframe {
                height: 250px;
            }
            
            .calculator-section {
                padding: 16px;
            }
            
            .form-grid {
                gap: 12px;
            }
            
            .input-group {
                margin-bottom: 12px;
            }
            
            .calculate-btn {
                padding: 14px 24px;
                font-size: 16px;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .result-item {
                padding: 12px;
            }
            
            .result-value {
                font-size: 18px;
            }
            
            /* Calculator ultra-mobile */
            .calculator-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }
            
            .calc-btn {
                min-height: 40px;
                font-size: 12px;
                padding: 4px 2px;
            }
            
            .calculator-display {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .calc-result {
                font-size: 24px;
            }
            
            .calc-expression {
                font-size: 12px;
            }
            
            .trig-functions {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 4px !important;
                margin-bottom: 8px !important;
            }
            
            .floating-buttons {
                bottom: 12px;
                right: 12px;
            }
            
            .floating-btn {
                width: 44px;
                height: 44px;
                font-size: 16px;
            }
        }

        @media (max-width: 320px) {
            .main-content {
                padding: 8px;
            }
            
            .metric-card {
                padding: 12px;
            }
            
            .metric-value {
                font-size: 20px;
            }
            
            .chart-container iframe {
                height: 200px;
            }
            
            .calculator-buttons {
                gap: 3px;
            }
            
            .calc-btn {
                min-height: 36px;
                font-size: 11px;
                padding: 2px 1px;
            }
            
            .trig-functions {
                gap: 3px !important;
            }
        }

        .portfolio-section {
            margin-bottom: 48px;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--border);
        }

        .portfolio-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-left: 16px;
            border-left: 3px solid var(--accent);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-positive { background: var(--accent); }
        .status-negative { background: var(--danger); }
        .status-neutral { background: var(--warning); }

        /* Floating Action Buttons */
        .floating-buttons {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        .floating-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 212, 170, 0.4);
        }

        .floating-btn.secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .floating-btn.secondary:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
        }

        /* Floating Calculator */
        .calculator-overlay {
            position: fixed;
            top: 24px;
            right: 24px;
            width: 400px;
            max-width: calc(100vw - 48px);
            height: calc(100vh - 48px);
            min-width: 320px;
            min-height: 500px;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: none;
            flex-direction: column;
            z-index: 2000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            resize: both;
            overflow: hidden;
        }

        .calculator-overlay.active {
            display: flex;
            transform: translateX(0);
        }

        .calculator-overlay:hover {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .calculator-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: linear-gradient(-45deg, transparent 40%, var(--border) 40%, var(--border) 50%, transparent 50%, transparent 60%, var(--border) 60%, var(--border) 70%, transparent 70%);
            cursor: nw-resize;
            border-radius: 0 0 12px 0;
        }

        .calculator-drag-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 40px;
            height: 60px;
            cursor: move;
            user-select: none;
            z-index: 10;
        }

        .floating-calculator {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            position: relative;
        }

        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .calculator-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .mode-toggle {
            display: flex;
            background: var(--primary);
            border-radius: 6px;
            padding: 2px;
            margin: 0 12px;
        }

        .mode-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: var(--accent);
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--surface);
            color: var(--text-primary);
        }

        .calculator-display {
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .calc-expression {
            color: var(--text-secondary);
            font-size: 14px;
            min-height: 20px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .calc-result {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            text-align: right;
            word-wrap: break-word;
        }

        .calculator-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            flex-shrink: 0;
            margin-bottom: 12px;
        }

        .calculator-buttons.advanced {
            grid-template-columns: repeat(5, 1fr);
        }

        .calc-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 4px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
        }

        .calc-btn:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
        }

        .calc-btn.operator {
            background: var(--accent);
            color: var(--primary);
            border-color: var(--accent);
        }

        .calc-btn.operator:hover {
            background: var(--accent-hover);
        }

        .calc-btn.function {
            background: #4a5568;
            color: white;
            font-size: 11px;
        }

        .calc-btn.function:hover {
            background: #5a6578;
        }

        .calc-btn.clear {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .calc-btn.clear:hover {
            background: #ff6b7a;
        }

        .calc-btn.wide {
            grid-column: span 2;
        }

        .variables-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .variables-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .variable-input {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .variable-input input {
            flex: 1;
            background: var(--primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 8px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .variable-input button {
            padding: 6px 12px;
            background: var(--accent);
            border: none;
            border-radius: 4px;
            color: var(--primary);
            font-size: 11px;
            cursor: pointer;
        }

        .stored-variables {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .variable-chip {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2px;
            word-break: break-word;
            max-width: 100%;
        }

        .variable-chip:hover {
            background: var(--accent);
            color: var(--primary);
        }

        .history-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            flex: 1;
            overflow-y: auto;
        }

        .history-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .history-item {
            background: var(--primary);
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: var(--surface);
        }

        .history-expression {
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .history-result {
            color: var(--text-primary);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">InvestTrack</div>
                <div class="logo-subtitle">Portfolio Analytics Suite</div>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <button class="nav-link active" onclick="showSection('dashboard')">
                            <span class="nav-icon">📊</span>
                            Dashboard
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" onclick="showSection('compound')">
                            <span class="nav-icon">📈</span>
                            Compound Interest
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" onclick="showSection('retirement')">
                            <span class="nav-icon">🎯</span>
                            Retirement Planning
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" onclick="showSection('portfolio')">
                            <span class="nav-icon">💼</span>
                            Portfolio Analysis
                        </button>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="content-area">
            <header class="top-bar">
                <h1 class="page-title" id="pageTitle">Performance Dashboard</h1>
                <div class="export-controls">
                    <button class="btn" onclick="printReport()">🖨️ Print</button>
                    <button class="btn btn-primary" onclick="generatePDF()">📄 Export PDF</button>
                </div>
            </header>

            <div class="main-content">
                <!-- Dashboard Section -->
                <section id="dashboard" class="page-section active">
                    <!-- Worldly Section -->
                    <div class="portfolio-section">
                        <h2 class="section-title">Worldly</h2>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="worldlyTotalReturn">--</div>
                                <div class="metric-label">Total Return</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="worldlyAnnualizedROI">--</div>
                                <div class="metric-label">Annualized ROI</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="worldlyVolatility">15.7%</div>
                                <div class="metric-label">Volatility</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">
                                    <span class="status-indicator status-positive"></span>Open
                                </div>
                                <div class="metric-label">Market Status</div>
                            </div>
                        </div>

                        <div class="chart-wrapper">
                            <h3 class="chart-title">Worldly Portfolio Performance</h3>
                            <div class="chart-container">
                                <iframe width="100%" height="400" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRMPS_1VP8AoRwKmvsic4jbximolB17nZTgpd4q-nGDfD3uBZb8QxI-e5utOy1OHImfMBT0sx7x_gd8/pubchart?oid=1750708711&format=interactive"></iframe>
                            </div>
                        </div>
                    </div>

                    <!-- Centralized Section -->
                    <div class="portfolio-section">
                        <h2 class="section-title">Centralized</h2>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-value" id="centralizedTotalReturn">--</div>
                                <div class="metric-label">Total Return</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="centralizedAnnualizedROI">--</div>
                                <div class="metric-label">Annualized ROI</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="centralizedVolatility">8.2%</div>
                                <div class="metric-label">Volatility</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value" id="centralizedStatus">
                                    <span class="status-indicator" id="centralizedStatusIndicator"></span>
                                    <span id="centralizedStatusText">--</span>
                                </div>
                                <div class="metric-label">Market Status</div>
                            </div>
                        </div>

                        <div class="chart-wrapper">
                            <h3 class="chart-title">Centralized Portfolio Performance</h3>
                            <div class="chart-container">
                                <iframe width="100%" height="400" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRMPS_1VP8AoRwKmvsic4jbximolB17nZTgpd4q-nGDfD3uBZb8QxI-e5utOy1OHImfMBT0sx7x_gd8/pubchart?oid=1750708711&format=interactive"></iframe>
                            </div>
                        </div>
                    </div>

                    <div class="calculator-section">
                        <h3 class="calculator-title">Quick ROI Calculator</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label class="input-label">Initial Investment</label>
                                <input type="number" class="input-field" id="quickInitial" placeholder="10,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Current Value</label>
                                <input type="number" class="input-field" id="quickCurrent" placeholder="12,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Time Period (months)</label>
                                <input type="number" class="input-field" id="quickTime" placeholder="12">
                            </div>
                        </div>
                        <button class="calculate-btn" onclick="calculateQuickROI()">Calculate ROI</button>
                        <div id="quickResult"></div>
                    </div>
                </section>

                <!-- Compound Interest Section -->
                <section id="compound" class="page-section">
                    <div class="calculator-section">
                        <h3 class="calculator-title">Compound Interest Calculator</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label class="input-label">Initial Capital</label>
                                <input type="number" class="input-field" id="principal" placeholder="10,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Monthly Contribution</label>
                                <input type="number" class="input-field" id="monthly" placeholder="500">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Annual Interest Rate (%)</label>
                                <input type="number" class="input-field" id="rate" placeholder="8" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Investment Years</label>
                                <input type="number" class="input-field" id="years" placeholder="10">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Compounding Frequency</label>
                                <select class="input-field" id="frequency">
                                    <option value="12">Monthly</option>
                                    <option value="4">Quarterly</option>
                                    <option value="2">Semi-Annual</option>
                                    <option value="1">Annual</option>
                                </select>
                            </div>
                        </div>
                        <button class="calculate-btn" onclick="calculateCompound()">Calculate Growth</button>
                        <div id="compoundResult"></div>
                    </div>
                </section>

                <!-- Retirement Planning Section -->
                <section id="retirement" class="page-section">
                    <div class="calculator-section">
                        <h3 class="calculator-title">Retirement Planning Calculator</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label class="input-label">Current Age</label>
                                <input type="number" class="input-field" id="currentAge" placeholder="30">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Retirement Age</label>
                                <input type="number" class="input-field" id="retirementAge" placeholder="65">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Current Savings</label>
                                <input type="number" class="input-field" id="currentSavings" placeholder="50,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Monthly Contribution</label>
                                <input type="number" class="input-field" id="monthlyContribution" placeholder="1,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Expected Return (%)</label>
                                <input type="number" class="input-field" id="expectedReturn" placeholder="7" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Annual Inflation (%)</label>
                                <input type="number" class="input-field" id="inflation" placeholder="3" step="0.1">
                            </div>
                        </div>
                        <button class="calculate-btn" onclick="calculateRetirement()">Plan Retirement</button>
                        <div id="retirementResult"></div>
                    </div>
                </section>

                <!-- Portfolio Analysis Section -->
                <section id="portfolio" class="page-section">
                    <div class="calculator-section">
                        <h3 class="calculator-title">Portfolio Analysis</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label class="input-label">Stocks Investment</label>
                                <input type="number" class="input-field" id="stocks" placeholder="40,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Bonds Investment</label>
                                <input type="number" class="input-field" id="bonds" placeholder="30,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Crypto Investment</label>
                                <input type="number" class="input-field" id="crypto" placeholder="20,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Cash Holdings</label>
                                <input type="number" class="input-field" id="cash" placeholder="10,000">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Stocks Return (%)</label>
                                <input type="number" class="input-field" id="stockReturn" placeholder="10" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Bonds Return (%)</label>
                                <input type="number" class="input-field" id="bondReturn" placeholder="4" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Crypto Return (%)</label>
                                <input type="number" class="input-field" id="cryptoReturn" placeholder="25" step="0.1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Cash Return (%)</label>
                                <input type="number" class="input-field" id="cashReturn" placeholder="1" step="0.1">
                            </div>
                        </div>
                        <button class="calculate-btn" onclick="calculatePortfolio()">Analyze Portfolio</button>
                        <div id="portfolioResult"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-buttons">
        <button class="floating-btn secondary" onclick="openCalculator()" title="Calculator">
            🧮
        </button>
        <button class="floating-btn" onclick="scrollToTop()" title="Back to Top">
            ↑
        </button>
    </div>

    <!-- Floating Calculator Overlay -->
    <div class="calculator-overlay" id="calculatorOverlay">
        <div class="calculator-drag-handle" id="dragHandle"></div>
        <div class="floating-calculator">
            <div class="calculator-header">
                <h3 class="calculator-title">Advanced Calculator</h3>
                <div class="mode-toggle">
                    <button class="mode-btn active" id="basicMode" onclick="switchMode('basic')">Basic</button>
                    <button class="mode-btn" id="advancedMode" onclick="switchMode('advanced')">Advanced</button>
                </div>
                <button class="close-btn" onclick="closeCalculator()">×</button>
            </div>
            
            <div class="calculator-display">
                <div class="calc-expression" id="calcExpression"></div>
                <div class="calc-result" id="calcResult">0</div>
            </div>
            
            <div class="calculator-content">
                <div class="calculator-buttons" id="calculatorButtons">
                    <!-- Basic Mode Buttons -->
                    <button class="calc-btn clear" onclick="clearAll()">C</button>
                    <button class="calc-btn clear" onclick="clearEntry()">CE</button>
                    <button class="calc-btn operator" onclick="deleteLast()">⌫</button>
                    <button class="calc-btn function" onclick="inputFunction('(')">(</button>
                    <button class="calc-btn function" onclick="inputFunction(')')">)</button>
                    
                    <button class="calc-btn function" onclick="inputFunction('sqrt(')" title="Square Root">√</button>
                    <button class="calc-btn function" onclick="inputFunction('pow(')" title="Power">x^y</button>
                    <button class="calc-btn function" onclick="inputFunction('log(')" title="Logarithm">log</button>
                    <button class="calc-btn function" onclick="inputFunction('ln(')" title="Natural Log">ln</button>
                    <button class="calc-btn operator" onclick="inputOperator('/')">/</button>
                    
                    <button class="calc-btn" onclick="inputNumber('7')">7</button>
                    <button class="calc-btn" onclick="inputNumber('8')">8</button>
                    <button class="calc-btn" onclick="inputNumber('9')">9</button>
                    <button class="calc-btn operator" onclick="inputOperator('*')">×</button>
                    <button class="calc-btn function" onclick="inputFunction('!')" title="Factorial">!</button>
                    
                    <button class="calc-btn" onclick="inputNumber('4')">4</button>
                    <button class="calc-btn" onclick="inputNumber('5')">5</button>
                    <button class="calc-btn" onclick="inputNumber('6')">6</button>
                    <button class="calc-btn operator" onclick="inputOperator('-')">-</button>
                    <button class="calc-btn function" onclick="inputFunction('%')" title="Modulo">%</button>
                    
                    <button class="calc-btn" onclick="inputNumber('1')">1</button>
                    <button class="calc-btn" onclick="inputNumber('2')">2</button>
                    <button class="calc-btn" onclick="inputNumber('3')">3</button>
                    <button class="calc-btn operator" onclick="inputOperator('+')">+</button>
                    <button class="calc-btn function" onclick="inputConstant('pi')" title="Pi">π</button>
                    
                    <button class="calc-btn wide" onclick="inputNumber('0')">0</button>
                    <button class="calc-btn" onclick="inputNumber('.')">.</button>
                    <button class="calc-btn operator" onclick="calculate()">=</button>
                    <button class="calc-btn function" onclick="inputConstant('e')" title="Euler's number">e</button>
                </div>

                <!-- Variables Section -->
                <div class="variables-section" id="variablesSection" style="display: none;">
                    <div class="variables-title">Variables</div>
                    <div class="variable-input">
                        <input type="text" id="variableName" placeholder="Variable name (x, rate, price...)" maxlength="15">
                        <input type="text" id="variableValue" placeholder="Value">
                        <button onclick="storeVariable()">Store</button>
                    </div>
                    <div class="stored-variables" id="storedVariables"></div>
                </div>

                <!-- History Section -->
                <div class="history-section">
                    <div class="history-title">History</div>
                    <div id="calculationHistory"></div>
                </div>
            </div>
        </div>
        <div class="calculator-resize-handle" id="resizeHandle"></div>
    </div>

    <script>
        const pageTitles = {
            'dashboard': 'Performance Dashboard',
            'compound': 'Compound Interest Calculator',
            'retirement': 'Retirement Planning',
            'portfolio': 'Portfolio Analysis'
        };

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked nav link
            event.target.classList.add('active');
            
            // Update page title
            document.getElementById('pageTitle').textContent = pageTitles[sectionId];
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatPercentage(value) {
            return (value * 100).toFixed(2) + '%';
        }

        function createResultPanel(title, items) {
            const resultGrid = items.map(item => `
                <div class="result-item">
                    <div class="result-value">${item.value}</div>
                    <div class="result-label">${item.label}</div>
                </div>
            `).join('');

            return `
                <div class="result-panel">
                    <div class="result-title">${title}</div>
                    <div class="result-grid">
                        ${resultGrid}
                    </div>
                </div>
            `;
        }

        function updateCentralizedMarketStatus() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5; // Monday to Friday
            
            const statusIndicator = document.getElementById('centralizedStatusIndicator');
            const statusText = document.getElementById('centralizedStatusText');
            
            if (isWeekday) {
                statusIndicator.className = 'status-indicator status-positive';
                statusText.textContent = 'Active';
            } else {
                statusIndicator.className = 'status-indicator status-negative';
                statusText.textContent = 'Closed Market';
            }
        }

        function calculateQuickROI() {
            const initial = parseFloat(document.getElementById('quickInitial').value) || 0;
            const current = parseFloat(document.getElementById('quickCurrent').value) || 0;
            const time = parseFloat(document.getElementById('quickTime').value) || 0;

            if (initial === 0 || time === 0) return;

            const totalReturn = ((current - initial) / initial);
            const annualizedReturn = Math.pow((current / initial), (12 / time)) - 1;
            const gainLoss = current - initial;

            const resultItems = [
                { value: formatPercentage(totalReturn), label: 'Total Return' },
                { value: formatPercentage(annualizedReturn), label: 'Annualized Return' },
                { value: formatCurrency(gainLoss), label: 'Gain/Loss' },
                { value: formatCurrency(current), label: 'Current Value' }
            ];

            document.getElementById('quickResult').innerHTML = createResultPanel('ROI Analysis Results', resultItems);

            // Update dashboard metrics for both sections
            // Worldly (original values with higher volatility - always open)
            document.getElementById('worldlyTotalReturn').textContent = formatPercentage(totalReturn);
            document.getElementById('worldlyAnnualizedROI').textContent = formatPercentage(annualizedReturn);

            // Centralized (assuming slightly better performance - status depends on weekday)
            const centralizedMultiplier = 0.85; // 15% lower volatility
            document.getElementById('centralizedTotalReturn').textContent = formatPercentage(totalReturn * centralizedMultiplier);
            document.getElementById('centralizedAnnualizedROI').textContent = formatPercentage(annualizedReturn * centralizedMultiplier);
        }

        // Initialize market status on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCentralizedMarketStatus();
            
            // Update market status every minute
            setInterval(updateCentralizedMarketStatus, 60000);
        });

        // Floating Action Buttons Functions
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function openCalculator() {
            document.getElementById('calculatorOverlay').classList.add('active');
            initializeDragAndResize();
        }

        function closeCalculator() {
            document.getElementById('calculatorOverlay').classList.remove('active');
        }

        // Drag and Resize Functionality
        function initializeDragAndResize() {
            const calculator = document.getElementById('calculatorOverlay');
            const dragHandle = document.getElementById('dragHandle');
            const resizeHandle = document.getElementById('resizeHandle');
            
            // Skip drag/resize on mobile devices
            if (window.innerWidth <= 1024) {
                return;
            }
            
            let isDragging = false;
            let isResizing = false;
            let dragStartX, dragStartY, initialX, initialY;
            let resizeStartX, resizeStartY, initialWidth, initialHeight;

            // Drag functionality
            dragHandle.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                const rect = calculator.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;
                
                calculator.style.transition = 'none';
                e.preventDefault();
            });

            // Resize functionality
            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizeStartX = e.clientX;
                resizeStartY = e.clientY;
                
                const rect = calculator.getBoundingClientRect();
                initialWidth = rect.width;
                initialHeight = rect.height;
                
                calculator.style.transition = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - dragStartX;
                    const deltaY = e.clientY - dragStartY;
                    
                    const newX = initialX + deltaX;
                    const newY = initialY + deltaY;
                    
                    // Keep calculator within viewport bounds
                    const maxX = window.innerWidth - calculator.offsetWidth;
                    const maxY = window.innerHeight - calculator.offsetHeight;
                    
                    calculator.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
                    calculator.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
                    calculator.style.right = 'auto';
                }
                
                if (isResizing) {
                    const deltaX = e.clientX - resizeStartX;
                    const deltaY = e.clientY - resizeStartY;
                    
                    const newWidth = Math.max(320, initialWidth + deltaX);
                    const newHeight = Math.max(500, initialHeight + deltaY);
                    
                    // Keep within viewport bounds
                    const maxWidth = window.innerWidth - calculator.offsetLeft;
                    const maxHeight = window.innerHeight - calculator.offsetTop;
                    
                    calculator.style.width = Math.min(newWidth, maxWidth) + 'px';
                    calculator.style.height = Math.min(newHeight, maxHeight) + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging || isResizing) {
                    calculator.style.transition = 'transform 0.3s ease';
                    isDragging = false;
                    isResizing = false;
                }
            });

            // Double-click to reset position and size
            dragHandle.addEventListener('dblclick', () => {
                calculator.style.left = 'auto';
                calculator.style.top = '24px';
                calculator.style.right = '24px';
                calculator.style.width = '400px';
                calculator.style.height = 'calc(100vh - 48px)';
            });
        }

        // Advanced Calculator Functions
        let currentExpression = '';
        let calculationHistory = [];
        let variables = {};
        let currentMode = 'basic';

        function updateDisplay() {
            document.getElementById('calcExpression').textContent = currentExpression;
            try {
                if (currentExpression) {
                    const result = evaluateExpression(currentExpression);
                    document.getElementById('calcResult').textContent = result;
                } else {
                    document.getElementById('calcResult').textContent = '0';
                }
            } catch (e) {
                document.getElementById('calcResult').textContent = 'Error';
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('basicMode').classList.toggle('active', mode === 'basic');
            document.getElementById('advancedMode').classList.toggle('active', mode === 'advanced');
            document.getElementById('variablesSection').style.display = mode === 'advanced' ? 'block' : 'none';
            
            const buttonsContainer = document.getElementById('calculatorButtons');
            if (mode === 'advanced') {
                buttonsContainer.classList.add('advanced');
                addAdvancedButtons();
            } else {
                buttonsContainer.classList.remove('advanced');
                removeAdvancedButtons();
            }
        }

        function addAdvancedButtons() {
            const buttonsContainer = document.getElementById('calculatorButtons');
            
            // Remove existing advanced buttons if any
            removeAdvancedButtons();
            
            // Create a container for trigonometric functions
            const trigButtons = document.createElement('div');
            trigButtons.className = 'trig-functions';
            trigButtons.style.cssText = `
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                margin-bottom: 12px;
                padding-top: 12px;
                border-top: 1px solid var(--border);
            `;
            
            const trigFunctions = [
                { func: 'sin(', label: 'sin', title: 'Sine' },
                { func: 'cos(', label: 'cos', title: 'Cosine' },
                { func: 'tan(', label: 'tan', title: 'Tangent' },
                { func: 'asin(', label: 'asin', title: 'Arcsine' },
                { func: 'acos(', label: 'acos', title: 'Arccosine' },
                { func: 'atan(', label: 'atan', title: 'Arctangent' }
            ];
            
            trigFunctions.forEach(item => {
                const button = document.createElement('button');
                button.className = 'calc-btn function';
                button.textContent = item.label;
                button.title = item.title;
                button.onclick = () => inputFunction(item.func);
                trigButtons.appendChild(button);
            });
            
            buttonsContainer.appendChild(trigButtons);
        }

        function removeAdvancedButtons() {
            const trigButtons = document.querySelector('.trig-functions');
            if (trigButtons) {
                trigButtons.remove();
            }
        }

        function inputNumber(num) {
            currentExpression += num;
            updateDisplay();
        }

        function inputOperator(op) {
            if (op === '*') op = '*';
            currentExpression += op;
            updateDisplay();
        }

        function inputFunction(func) {
            currentExpression += func;
            updateDisplay();
        }

        function inputConstant(constant) {
            const constants = {
                'pi': Math.PI,
                'e': Math.E
            };
            currentExpression += constants[constant];
            updateDisplay();
        }

        function deleteLast() {
            currentExpression = currentExpression.slice(0, -1);
            updateDisplay();
        }

        function clearEntry() {
            currentExpression = '';
            updateDisplay();
        }

        function clearAll() {
            currentExpression = '';
            updateDisplay();
        }

        function calculate() {
            if (!currentExpression) return;
            
            try {
                const result = evaluateExpression(currentExpression);
                
                // Add to history
                calculationHistory.unshift({
                    expression: currentExpression,
                    result: result
                });
                
                if (calculationHistory.length > 10) {
                    calculationHistory = calculationHistory.slice(0, 10);
                }
                
                updateHistory();
                
                currentExpression = result.toString();
                updateDisplay();
                
            } catch (error) {
                document.getElementById('calcResult').textContent = 'Error';
            }
        }

        function evaluateExpression(expr) {
            // Replace mathematical functions
            let processedExpr = expr
                .replace(/sqrt\(/g, 'Math.sqrt(')
                .replace(/pow\(/g, 'Math.pow(')
                .replace(/log\(/g, 'Math.log10(')
                .replace(/ln\(/g, 'Math.log(')
                .replace(/sin\(/g, 'Math.sin(')
                .replace(/cos\(/g, 'Math.cos(')
                .replace(/tan\(/g, 'Math.tan(')
                .replace(/asin\(/g, 'Math.asin(')
                .replace(/acos\(/g, 'Math.acos(')
                .replace(/atan\(/g, 'Math.atan(')
                .replace(/!/g, '/* factorial */');

            // Replace variables (improved to handle word variables)
            Object.keys(variables).sort((a, b) => b.length - a.length).forEach(variable => {
                const regex = new RegExp(`\\b${variable}\\b`, 'g');
                processedExpr = processedExpr.replace(regex, variables[variable]);
            });

            // Handle factorial
            processedExpr = processedExpr.replace(/(\d+)\/\* factorial \*\//g, (match, num) => {
                return factorial(parseInt(num));
            });

            // Evaluate the expression
            return Function('"use strict"; return (' + processedExpr + ')')();
        }

        function factorial(n) {
            if (n < 0) return NaN;
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function storeVariable() {
            const name = document.getElementById('variableName').value.trim();
            const value = document.getElementById('variableValue').value.trim();
            
            if (name && value && /^[a-zA-Z][a-zA-Z0-9_]*$/.test(name)) {
                try {
                    variables[name] = parseFloat(value) || evaluateExpression(value);
                    document.getElementById('variableName').value = '';
                    document.getElementById('variableValue').value = '';
                    updateVariablesDisplay();
                } catch (e) {
                    alert('Invalid value');
                }
            } else {
                alert('Variable name must start with a letter and contain only letters, numbers, and underscores');
            }
        }

        function updateVariablesDisplay() {
            const container = document.getElementById('storedVariables');
            container.innerHTML = '';
            
            Object.keys(variables).forEach(variable => {
                const chip = document.createElement('div');
                chip.className = 'variable-chip';
                chip.innerHTML = `
                    <div style="font-weight: 600; color: var(--accent);">${variable}</div>
                    <div style="font-size: 10px;">= ${variables[variable]}</div>
                `;
                chip.onclick = () => {
                    currentExpression += variable;
                    updateDisplay();
                };
                
                // Add delete functionality with right-click
                chip.oncontextmenu = (e) => {
                    e.preventDefault();
                    if (confirm(`Delete variable "${variable}"?`)) {
                        delete variables[variable];
                        updateVariablesDisplay();
                    }
                };
                
                container.appendChild(chip);
            });
        }

        function updateHistory() {
            const container = document.getElementById('calculationHistory');
            container.innerHTML = '';
            
            calculationHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-expression">${item.expression}</div>
                    <div class="history-result">= ${item.result}</div>
                `;
                historyItem.onclick = () => {
                    currentExpression = item.expression;
                    updateDisplay();
                };
                container.appendChild(historyItem);
            });
        }

        // Enhanced keyboard support
        document.addEventListener('keydown', function(event) {
            const calcOverlay = document.getElementById('calculatorOverlay');
            if (!calcOverlay.classList.contains('active')) return;

            const key = event.key;
            
            if (key >= '0' && key <= '9' || key === '.') {
                inputNumber(key);
            } else if (key === '+' || key === '-') {
                inputOperator(key);
            } else if (key === '*') {
                inputOperator('*');
            } else if (key === '/') {
                event.preventDefault();
                inputOperator('/');
            } else if (key === '(' || key === ')') {
                inputFunction(key);
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault();
                calculate();
            } else if (key === 'Escape') {
                closeCalculator();
            } else if (key === 'Backspace') {
                deleteLast();
            } else if (key === 'Delete') {
                clearEntry();
            }
        });

        function calculateCompound() {
            const principal = parseFloat(document.getElementById('principal').value) || 0;
            const monthly = parseFloat(document.getElementById('monthly').value) || 0;
            const rate = parseFloat(document.getElementById('rate').value) / 100 || 0;
            const years = parseFloat(document.getElementById('years').value) || 0;
            const frequency = parseFloat(document.getElementById('frequency').value) || 12;

            const periodicRate = rate / frequency;
            const totalPeriods = years * frequency;
            const monthlyPeriods = years * 12;

            const futureValuePrincipal = principal * Math.pow((1 + periodicRate), totalPeriods);
            const monthlyRate = rate / 12;
            const futureValueAnnuity = monthly * (Math.pow(1 + monthlyRate, monthlyPeriods) - 1) / monthlyRate;

            const totalFutureValue = futureValuePrincipal + futureValueAnnuity;
            const totalContributions = principal + (monthly * monthlyPeriods);
            const totalEarnings = totalFutureValue - totalContributions;

            const resultItems = [
                { value: formatCurrency(totalFutureValue), label: 'Final Value' },
                { value: formatCurrency(totalContributions), label: 'Total Contributed' },
                { value: formatCurrency(totalEarnings), label: 'Interest Earnings' },
                { value: formatPercentage(totalEarnings / totalContributions), label: 'Total ROI' }
            ];

            document.getElementById('compoundResult').innerHTML = createResultPanel('Compound Growth Projection', resultItems);
        }

        function calculateRetirement() {
            const currentAge = parseFloat(document.getElementById('currentAge').value) || 0;
            const retirementAge = parseFloat(document.getElementById('retirementAge').value) || 0;
            const currentSavings = parseFloat(document.getElementById('currentSavings').value) || 0;
            const monthlyContribution = parseFloat(document.getElementById('monthlyContribution').value) || 0;
            const expectedReturn = parseFloat(document.getElementById('expectedReturn').value) / 100 || 0;

            const yearsToRetirement = retirementAge - currentAge;
            const monthsToRetirement = yearsToRetirement * 12;
            const monthlyRate = expectedReturn / 12;

            const futureCurrentSavings = currentSavings * Math.pow(1 + expectedReturn, yearsToRetirement);
            const futureContributions = monthlyContribution * (Math.pow(1 + monthlyRate, monthsToRetirement) - 1) / monthlyRate;

            const totalRetirementFund = futureCurrentSavings + futureContributions;
            const totalContributed = currentSavings + (monthlyContribution * monthsToRetirement);
            const retirementIncome = totalRetirementFund * 0.04;

            const resultItems = [
                { value: formatCurrency(totalRetirementFund), label: 'Retirement Fund' },
                { value: formatCurrency(retirementIncome), label: 'Annual Income' },
                { value: formatCurrency(retirementIncome / 12), label: 'Monthly Income' },
                { value: `${yearsToRetirement} years`, label: 'Time to Retirement' }
            ];

            document.getElementById('retirementResult').innerHTML = createResultPanel('Retirement Plan Summary', resultItems);
        }

        function calculatePortfolio() {
            const stocks = parseFloat(document.getElementById('stocks').value) || 0;
            const bonds = parseFloat(document.getElementById('bonds').value) || 0;
            const crypto = parseFloat(document.getElementById('crypto').value) || 0;
            const cash = parseFloat(document.getElementById('cash').value) || 0;

            const stockReturn = parseFloat(document.getElementById('stockReturn').value) / 100 || 0;
            const bondReturn = parseFloat(document.getElementById('bondReturn').value) / 100 || 0;
            const cryptoReturn = parseFloat(document.getElementById('cryptoReturn').value) / 100 || 0;
            const cashReturn = parseFloat(document.getElementById('cashReturn').value) / 100 || 0;

            const totalPortfolio = stocks + bonds + crypto + cash;

            const stockWeight = stocks / totalPortfolio;
            const bondWeight = bonds / totalPortfolio;
            const cryptoWeight = crypto / totalPortfolio;
            const cashWeight = cash / totalPortfolio;

            const expectedReturn = (stockWeight * stockReturn) + (bondWeight * bondReturn) + 
                                 (cryptoWeight * cryptoReturn) + (cashWeight * cashReturn);

            const annualIncome = totalPortfolio * expectedReturn;

            const resultItems = [
                { value: formatCurrency(totalPortfolio), label: 'Total Value' },
                { value: formatPercentage(expectedReturn), label: 'Expected Return' },
                { value: formatCurrency(annualIncome), label: 'Annual Income' },
                { value: formatCurrency(annualIncome / 12), label: 'Monthly Income' }
            ];

            const breakdown = `
                <div class="portfolio-breakdown">
                    <div class="breakdown-item">Stocks<br><strong>${formatPercentage(stockWeight)}</strong></div>
                    <div class="breakdown-item">Bonds<br><strong>${formatPercentage(bondWeight)}</strong></div>
                    <div class="breakdown-item">Crypto<br><strong>${formatPercentage(cryptoWeight)}</strong></div>
                    <div class="breakdown-item">Cash<br><strong>${formatPercentage(cashWeight)}</strong></div>
                </div>
            `;

            document.getElementById('portfolioResult').innerHTML = createResultPanel('Portfolio Analysis', resultItems) + breakdown;
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text('Investment Performance Report', 20, 30);

            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 45);

            let yPos = 60;
            const activeSection = document.querySelector('.page-section.active');
            const sectionTitle = document.getElementById('pageTitle').textContent;

            doc.setFontSize(16);
            doc.text(sectionTitle, 20, yPos);
            yPos += 20;

            // Add basic report content
            doc.setFontSize(10);
            doc.text('This report contains investment analysis and projections.', 20, yPos);
            doc.text('All calculations are based on user inputs and historical data.', 20, yPos + 10);

            doc.save('investment-report.pdf');
        }

        function printReport() {
            window.print();
        }
    </script>
</body>
</html>
